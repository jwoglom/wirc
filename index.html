<!doctype html>
<html>
<head>
    <title>Wirc</title>
</head>
<link rel="stylesheet" type="text/css" href="core.css" />
<style>
h1 {
    font-size: 32px;
}
.channel, .welcome {
    display: none;
}
</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    uid = null;
    last = 0;
    channel = null;
    rawmsg = "";mynick = "";
    init = function() {
        $(".welcome").show();
        $("#nick").val("wirc_"+(Math.floor(Math.random()*1000)));
    }
    connectsmt = function() {
        var j = {
            m: "conn",
            server: $("#server").val(),
            port: $("#port").val(),
            nick: $("#nick").val(),
            realname: $("#realname").val(),
            chan: $("#chan").val()
        }
        $.post("req.php", j, function(d) {
            //console.log(d);
            uid = d;
            channel = j['chan'];
            mynick = j['nick'];
            setup();
            ping();
        });
    }
    send = function(msg) {
        $.post("req.php", {m: "send", uid: uid, msg: msg}, function(d) {
            console.log("Sent: "+d);
        });
    }
    setup = function() {
        $(".welcome").hide();
        $(".channel").show();
        setInterval(ping, 10000);
        nl(" * ", "One moment please...");
    }

    ping = function() {
        $.post("req.php", {m: "ping", "uid": uid, last: last}, function(d) {
            //console.log(d);
            last += d.length;
            upd(d);

        });
    }
    safe = function(t) { return t.replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    upd = function(c) {
        $("#messages").append(safe(c));
        rawmsg += c;

        parseraw(c);
        var ch = $('#messages');
        ch.scrollTop(
            ch[0].scrollHeight - ch.height()
        );
    }
    parseraw = function(r) {
        s = r.split('\n');
        for(var i=0; i<s.length; i++) {
            t = s[i].split(' ');
            t[0] = t[0].substring(1);

            console.log(t);
            if(t[1] == 'JOIN') {
                nl("<i>"+t[2].substring(1)+"</i>", t[0]+" has joined.");
            } else if(t[1] == 'PART') {
                nl("<i>"+t[2].substring(1)+"</i>", t[0]+" has parted.");
            } else if(t[3] == '=') {
                str = '';
                for(var j=5; j<t.length; j++) {
                    str+=t[j]+' ';
                }
                nl("<i>"+t[, "Users: "+str.substring(1));
            } else if(t[1] == 'PRIVMSG' && t[0] != 'UNNING:') {
                nl(t[0].split('!')[0], safe(s[i].split(':',3)[2]));
            }

        }
    }
    nl = function(u, t) {
        var h = "<tr><th>"+u+"</th><td>"+t+"</td></tr>";
        $("#marea").append(h);
    }
    sendmsg = function() {
        var v = $("#text").val();
        if(v.substring(0, 1) == '/') {
            if(v.substring(0,6) == '/nick ') {
                send("NICK "+v.substring(6));
            } else alert("Unsupported operation.");
        } else {
            send("PRIVMSG "+channel+" "+v);
            nl(mynick, v);
            $("#text").val("");
        }
    }

    $("#text").keyup(function(e) {
        if(e.keyCode == 13) {
            sendmsg();  
        }
    });
    init();
});

</script>
<body>
<div class="welcome">
<h1>Welcome to Wirc</h1>
Server: <input id="server" value="irc.bouncerstation.com" /><br />
Port: <input id="port" value=6667 /><br />
Nick: <input id="nick" value="wirc" /><br />
Realname: <input id="realname" value="AngelaWilliam" /><br />
Channel: <input id="chan" value="#private" /><br />
<button onclick="connectsmt()">Connect</button>
</div>
<div class="channel" style="padding: 30px">
    <table>
    <tr><td>
        <button onclick="$('#messages').toggle()">Show raw data</button><br />
        <textarea id="messages" style="width: 500px;height: 500px;display: none"></textarea>
        <table id="marea">
        </table>
    </td></tr>
    <tr><td>
        <input id="text" style="width: 450px" />
        <button onclick="sendmsg()" style="width: 50px;padding:5px">Send</button>
    </td></tr></table>
</div>
</body>
</html>